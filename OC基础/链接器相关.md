## 链接器相关

### iOS编译过程相关

iOS编写的代码是先使用编译器把代码编译成机器码，然后直接在CPU上执行机器码

使用编译器而不是解释器的目的是为了执行效率更高、运行速度能达到最快

编译器和解释器执行代码的特点如下

- 采用编译器生成机器码的好处是效率高，但是调试周期长
- 采用解释器执行的好处是编写调试方便，但是执行效率低

现在Apple使用的编译器是LLVM，LLVM是编译器工具链技术的一个集合。其中的lld项目就是内置链接器。编译器会对每个文件进行编译，生成Mach-0(可执行文件)，链接器会将项目中的多个Mach-o文件合并成一个

更多内容可以查看[参考链接](https://llvm.org/docs/)

编译的主要过程如下

- LLVM会预处理你的代码，比如将宏嵌入到对应的位置
- 预处理完后，LLVM会对代码进行词法分析和语法分析，生成AST。AST是抽象语法树，结构上比代码更精简，遍历起来更快，使用AST能够更快速地进行静态检查，还可以更快的生成IR(中间表示)
- 最后，AST会生成IR，IR是一种更接近机器码的语言，与平台无关，通过IR可以生成多份适合不同平台的机器码。iOS中，IR生成的可执行文件就是Mach-o

### 链接器

Mach-o文件里的内容，主要就是代码和数据：代码是函数的定义；数据是全局变量的定义，包括全局变量的初始值。他们的实例都需要由符号将其关联起来

链接器的作用就是完成变量、函数符号和其地址绑定的任务

符号就是指变量名和函数名

#### 链接器的目的

使用链接器的目的是为了延后绑定内存地址，不需要在写代码的时候就设置内存地址，可以提升可读性和可维护性

编译会对每个文件进行编译，生成多个Mach-o。如果没有经过绑定，单个的Mach-o文件一般是无法正常运行的，因为如果运行中遇到调用其他文件中的函数的情况，就会找不到函数地址，无法继续执行。因此，需要使用链接器链接多个文件，合并成一个Mach-o文件

链接器在链接过程中，会创建一个符号表，用于记录所有已定义和所有未定义的符号。

#### 链接错误

- "id:dumplicate symbols"表示出现了相同符号
- "Undefined symbols"表示在未找到符号

#### 链接器的工作

- 查找未定义的变量
- 扫描项目中的文件，将所有符号定义和引用地址收集并放入全局符号表中
- 计算合并后长度及位置，生成同类型的段进行合并，建立绑定
- 对项目中文件里的变量进行地址重定位

链接器会以main函数为源头，跟随每个引用，并标记为live。可以在build setting中设置dead code stripping为YES自动去除未标记为live的函数，这个开关是默认开启的
